o<toolchange> sub
(print, o<toolchange>)

(print, Current Tool: #<current_tool>)
(print, Current Pocket: #<current_pocket>)

(print, Selected Tool: #<selected_tool>)
(print, Selected Pocket: #<selected_pocket>)

(print, ****** ATC INFO ******)
(print, Number of Pockets: #<atc_num_pockets>)
(print, Open Pocket: #<atc_open_pocket>)


; End if tool in spindle is same as requested
O100 if [#<current_tool> EQ #<selected_tool>]
 o<toolchange> endsub [1]
M2
O100 endif


; Request manual removal if no pocket in ATC
O110 if [#<atc_open_pocket> LT 0]
 (print, No open pocket in the ATC, please remove manually.)
 o<toolchange> endsub [1]
M2
O110 endif


; checks if requested tool is in the ATC
O11 if [#<selected_pocket> LT 0]
 (abort, tool not in carousel)
 o<toolchange> endsub [1]
M2
O11 endif



O120 if [#<next_pocket> EQ 0] ; if tool is not found, aborts and sends a message
    (abort, tool not in carousel)
O120 endif

;now we know which pocket the next tool is sitting in
;we need to know if we need to put a tool away
;or if there is no tool in the spindle


; Check if there is a valid tool in the spindle
O180 IF [#<current_tool> GT 0]

    ; If there is a tool in the spindle, checks if there is an open pocket
    O190 if [#<open_pocket> EQ 0]
        (abort, carousel is full, cant put away tool in into carousel)
    O190 endif

    ; move carousel to an open pocket
    M10 P[#<open_pocket>]
        M21 ; puts the tool in spindle away into the open pocket
        (DEBUG, EVAL[vcp.getWidget{"dynatc"}.store_tool{#<open_pocket>, #110}])
        #30 = #<open_pocket>
    ##30 = #110 ; save tool number in pocket
    #5231 = 0 ; empty tool in the spindle

O180 ENDIF

G0 G53 Z0

O200 IF [#100 GT 0] ; selected tool is not tool0
    M10 P#<next_pocket> ;set the carousel to move to the right pocket for the selected tool
    M65 P1
    M64 P0
    M66 P1 L3 Q5 ;check carousel out position sensor
    O205 if [#5399 LT 0]
	 M65 P0 ; turn off the solonoid to send atc to tool change
      (abort, failed to send carousel home) ; abort if the 	sensor does not activate in 5 seconds
    O205 endif
    M65 P0

    (DEBUG, EVAL[vcp.getWidget{"dynatc"}.store_tool{#<next_pocket>, 0}])
    M22 ;Carousel out
    #25 = #<next_pocket>
    ##25 = 0 ; empty the pocket

    #5231 = #100 ;Set persistent variable to remember tool in spindle after power cycle

O200 Else

M65 P2 ; deactive drawbar
M65 P0 ; make sure ATC out solonoid is off
M64 P1 ; move carousel home

M66 P0 L3 Q4 ;check carousel in position sensor
   O210 if [#5399 LT 0]
	 M65 P1 ; turn off the solonoid to send atc home
      (abort, failed to send carousel home) ; abort if the 	sensor does not activate in 5 seconds
   O210 endif
M65 P1
O200 ENDIF

;assign the tool numbers in the pockets to the parameters
#5190= #1
#5191= #2
#5192= #3
#5193= #4
#5194= #5
#5195= #6
#5196= #7
#5197= #8
#5198= #9
#5199= #10
#5200= #11
#5201= #12

M61 Q#100

o<toolchange> endsub [1]

M2
